{% set version = "0.3.1" %}
{% set soname = version.split(".")[0] %}

package:
  name: libmathdx-split
  version: {{ version }}

source:
  - url: https://developer.nvidia.com/downloads/compute/cublasdx/redist/cublasdx/cuda12/libmathdx-Linux-x86_64-{{ version }}-cuda12.0.tar.gz  # [linux and x86_64 and (cuda_compiler_version or "None").startswith("12")]
    sha256: b282f95f0028b39880e7e77155ecd015700905286afd88bd631072894090f9d9  # [linux and x86_64 and (cuda_compiler_version or "None").startswith("12")]
  - url: https://developer.nvidia.com/downloads/compute/cublasdx/redist/cublasdx/cuda13/libmathdx-Linux-x86_64-{{ version }}-cuda13.0.tar.gz  # [linux and x86_64 and (cuda_compiler_version or "None").startswith("13")]
    sha256: 5a1d9a99a0b82d5e2cc213cf89c084aff69da8d8ea88619f327f9ac6fca603d1  # [linux and x86_64 and (cuda_compiler_version or "None").startswith("13")]
  - url: https://developer.nvidia.com/downloads/compute/cublasdx/redist/cublasdx/cuda12/libmathdx-Linux-aarch64-{{ version }}-cuda12.0.tar.gz  # [linux and aarch64 and (cuda_compiler_version or "None").startswith("12")]
    sha256: 866ed56c33677273f10a65285b74609541cf89374558e2434ac9fb5d4c9de3ba  # [linux and aarch64 and (cuda_compiler_version or "None").startswith("12")]
  - url: https://developer.nvidia.com/downloads/compute/cublasdx/redist/cublasdx/cuda13/libmathdx-Linux-aarch64-{{ version }}-cuda13.0.tar.gz  # [linux and aarch64 and (cuda_compiler_version or "None").startswith("13")]
    sha256: 3962509f35027b299e6b60cfad3139d8fa2dd07aa6a919533f529e2c30690057  # [linux and aarch64 and (cuda_compiler_version or "None").startswith("13")]
  - url: https://developer.nvidia.com/downloads/compute/cublasdx/redist/cublasdx/cuda12/libmathdx-win32-x86_64-{{ version }}-cuda12.0.zip  # [win and x86_64 and (cuda_compiler_version or "None").startswith("12")]
    sha256: 64488decd3bf6e09a717cec966ad96b10fe2e9db7935185ecb491cfd6c2ec514  # [win and x86_64 and (cuda_compiler_version or "None").startswith("12")]
  - url: https://developer.nvidia.com/downloads/compute/cublasdx/redist/cublasdx/cuda13/libmathdx-win32-x86_64-{{ version }}-cuda13.0.zip  # [win and x86_64 and (cuda_compiler_version or "None").startswith("13")]
    sha256: 33b162f5ba9a0d6eb123b60b25c576711641be817d463e1bad361f314d5f2246  # [win and x86_64 and (cuda_compiler_version or "None").startswith("13")]

build:
  number: 0
  skip: true  # [((cuda_compiler_version or "").startswith("11")) or ((cuda_compiler_version or "None") == "None")]
  script:
    - check-glibc $SRC_DIR/lib*/*.so.*  # [linux]
    - mkdir -p $PREFIX/include/  # [linux]
    - cp -r $SRC_DIR/include/* $PREFIX/include/  # [linux]
    - mkdir -p $PREFIX/lib/  # [linux]
    - cp -r $SRC_DIR/lib/* $PREFIX/lib/  # [linux]
    - mkdir %PREFIX%\include\  # [win]
    - xcopy "%SRC_DIR%\include\*" "%PREFIX%\Library\include\" /E /I /Y  # [win]
    - mkdir %PREFIX%\Library\bin\  # [win]
    - xcopy "%SRC_DIR%\bin\*.dll" "%PREFIX%\Library\bin\" /E /I /Y  # [win]
    - mkdir %PREFIX%\Library\lib\  # [win]
    - xcopy "%SRC_DIR%\lib\*" "%PREFIX%\Library\lib\" /E /I /Y  # [win]

requirements:
  build:
    - cf-nvidia-tools 1.*  # [linux]

outputs:
  - name: libmathdx{{ soname }}
    build:
      ignore_run_exports:
        - cuda-nvrtc
        - cuda-version
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('cuda') }}
        - {{ stdlib('c') }}
      host:
        - cuda-version {{ cuda_compiler_version }}
        - cuda-nvrtc-dev
      run:
        - {{ pin_compatible('cuda-version', min_pin='x', max_pin='x') }}
        - cuda-nvrtc
    files:
      - lib/libmathdx.so.*  # [linux]
      - Library\bin\mathdx*.dll  # [win]
    test:
      commands:
        - test -L $PREFIX/lib/libmathdx.so.{{ soname }}  # [linux]
        - test -f $PREFIX/lib/libmathdx.so.{{ version }}  # [linux]
        - if not exist %PREFIX%\Library\bin\mathdx64_{{ soname }}.dll exit 1  # [win]
    about:
      summary: The libmathdx runtime library.
      description: >-
        This is a runtime package only. Developers should install libmathdx-dev to build with libmathdx.
      license: LicenseRef-MathDx-Software-License-Agreement
      license_file: LICENSE.txt

  - name: libmathdx
    build:
      noarch: generic
    requirements:
      host:
        - {{ pin_subpackage('libmathdx' ~ soname, max_pin=None) }}
      run:
      # FIXME: max_pin=None when library is stable
        - {{ pin_subpackage('libmathdx' ~ soname, max_pin="x.x.x") }}
    about:
      summary: The libmathdx runtime library.
      description: >-
        This is a runtime package only. Developers should install libmathdx-dev to build with libmathdx.
      license: LicenseRef-MathDx-Software-License-Agreement
      license_file: LICENSE.txt

  - name: libmathdx-dev
    build:
      run_exports:
      # FIXME: both run_exports max_pin=None when library is stable
        - {{ pin_subpackage('libmathdx', max_pin="x.x.x") }}
        - {{ pin_subpackage('libmathdx' ~ soname, max_pin="x.x.x") }}
    requirements:
      host:
        - cuda-version {{ cuda_compiler_version }}
        - {{ pin_subpackage('libmathdx', exact=True) }}
        - {{ pin_subpackage('libmathdx' ~ soname, exact=True) }}
      run:
        - {{ pin_compatible('cuda-version', min_pin='x', max_pin='x') }}
        - {{ pin_subpackage('libmathdx', exact=True) }}
        - {{ pin_subpackage('libmathdx' ~ soname, exact=True) }}
    files:
      - include  # [linux]
      - Library\include\  # [win]
      - lib/libmathdx.so  # [linux]
      - Library\lib\x64\mathdx.lib  # [win]
    test:
      commands:
        - test -f $PREFIX/include/libcufftdx.h  # [linux]
        - test -f $PREFIX/include/libcublasdx.h  # [linux]
        - test -f $PREFIX/include/libcusolverdx.h  # [linux]
        - test -f $PREFIX/include/libmathdx.h  # [linux]
        - test -f $PREFIX/include/libcommondx.h  # [linux]
        - test -L $PREFIX/lib/libmathdx.so  # [linux]
        - test ! -f $PREFIX/lib/libmathdx_static.a  # [linux]
        - if not exist %PREFIX%\Library\include\libcufftdx.h exit 1  # [win]
        - if not exist %PREFIX%\Library\include\libcublasdx.h exit 1  # [win]
        - if not exist %PREFIX%\Library\include\libcusolverdx.h exit 1  # [win]
        - if not exist %PREFIX%\Library\include\libmathdx.h exit 1  # [win]
        - if not exist %PREFIX%\Library\include\libcommondx.h exit 1  # [win]
        - if not exist %PREFIX%\Library\lib\x64\mathdx.lib exit 1  # [win]
        - if exist %PREFIX%\Library\lib\x64\mathdx_static.lib exit 1  # [win]

  - name: libmathdx-static
    build:
      ignore_run_exports:
        - cuda-version
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('cuda') }}
        - {{ stdlib('c') }}
      host:
        - cuda-version {{ cuda_compiler_version }}
        - {{ pin_subpackage('libmathdx-dev', exact=True) }}
      run:
        - {{ pin_compatible('cuda-version', min_pin='x', max_pin='x') }}
        - {{ pin_subpackage('libmathdx-dev', exact=True) }}
    files:
      - lib/libmathdx_static.a  # [linux]
      - Library\lib\x64\mathdx_static.lib  # [win]
    test:
      commands:
        - test -f $PREFIX/lib/libmathdx_static.a  # [linux]
        - if not exist %PREFIX%\Library\lib\x64\mathdx_static.lib exit 1  # [win]
    about:
      summary: The libmathdx static library.
      description: >-
        Developers should install this package to link statically with libmathdx.
      license: LicenseRef-MathDx-Software-License-Agreement
      license_file: LICENSE.txt

about:
  home: https://developer.nvidia.com/mathdx
  license: LicenseRef-MathDx-Software-License-Agreement
  license_file: LICENSE.txt
  license_url: https://docs.nvidia.com/cuda/cufftdx/license.html
  summary: The development package for libmathdx.
  description: >-
    NVIDIA libmathdx is a runtime code-generation library for cuFFTDx and cuBLASDx. This is the development package. Developers should install this package to link dynamically with libmathdx.
  doc_url: https://docs.nvidia.com/cuda/cufftdx/index.html

extra:
  feedstock-name: libmathdx
  recipe-maintainers:
    - conda-forge/cuda
